<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spinning 3D Earth</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: serif;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #fadeOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            z-index: 2;
        }

        .navbar {
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 3000;
        }

        .navbar a {
            color: white;
            text-align: center;
            padding: 1rem 2rem;
            text-decoration: none;
            margin: 0 30px;
            transition: 0.4s;
        }

        .navbar a:hover {
            background-color: white;
            color: black;
        }

        /* Styles for the Urban text */
        .urban-text {
        position: fixed;
        bottom: 65%;  
        left: 10%;    /* Moved more to the left */
        font-size: 150px;
        font-family: serif;
        color: white;
        z-index: 3;
        }

        /* Adjusted styles for the Oceans text without the O */
        .oceans-text {
            position: fixed;
            bottom: 35%;
            left: 60%;  /* Moved more to the right */
            font-size: 300px;  /* Increased font size */
            font-family: serif;
            color: white;
            z-index: 3;
        }

        /* Add transition for opacity */
        .urban-text, .oceans-text {
            transition: opacity 0.5s ease-out;
        }

    </style>
</head>

<body>
    {%include 'navbar.html'%}
    <div id="fadeOverlay"></div>

    <div class="urban-text">Urban</div>
    
    <!-- Oceans Text (Without the O) -->
    <div class="oceans-text">ceans</div>

    <script src="https://threejs.org/build/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script>
        let scene, camera, renderer, earth, ocean;
        let buttonAtlantic, buttonCalifornia;
        let autoRotate = true;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        init();
        animate();

        function init() {
            sceneSetup();
            earthSetup();
            oceanSetup();
            buttonsSetup();
            eventSetup();
            earth.scale.set(1.2, 1.2, 1.2);
        }

        function sceneSetup() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
        }

        function earthSetup() {
            const geometry = new THREE.SphereGeometry(1, 128, 128);
            const texture = new THREE.TextureLoader().load('/static/images/earth.png');
            const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
            earth = new THREE.Mesh(geometry, material);
            scene.add(earth);
        }

        function oceanSetup() {
            const oceanGeometry = new THREE.PlaneGeometry(50, 50, 50, 50);
            const oceanMaterial = new THREE.MeshBasicMaterial({ color: 0x1E90FF, side: THREE.DoubleSide });
            ocean = new THREE.Mesh(oceanGeometry, oceanMaterial);
            ocean.rotation.x = -Math.PI / 2;
            ocean.position.y = -2;
            ocean.visible = false;
            scene.add(ocean);
        }

        function buttonsSetup() {
            const buttonGeometry = new THREE.SphereGeometry(0.05, 32, 32);
            const buttonMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            buttonAtlantic = new THREE.Mesh(buttonGeometry, buttonMaterial);
            buttonCalifornia = new THREE.Mesh(buttonGeometry, buttonMaterial);
            setPositionOnEarth(buttonAtlantic, 30, 150);
            setPositionOnEarth(buttonCalifornia, 55, 240);
            earth.add(buttonAtlantic, buttonCalifornia);
        }

        function eventSetup() {
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('click', onDocumentClick);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('wheel', onWheelScroll, { passive: false });
        }

        function setPositionOnEarth(object, lat, lon) {
            const radius = 1.01;
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            object.position.setFromSphericalCoords(radius, phi, theta);
        }

        function onDocumentClick(event) {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.intersectObjects([buttonAtlantic, buttonCalifornia]).length) {
                fadeScreenAndZoomToButton();
            }
        }

        function animate() {
            if (autoRotate) earth.rotation.y += 0.005;
            renderer.render(scene, camera);
            TWEEN.update();
            requestAnimationFrame(animate);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        let scrollTimeout;
        let isScrolling = false;

        function onWheelScroll(event) {
            const scaleFactor = event.deltaY > 0 ? 1.01 : 0.99;
            earth.scale.multiplyScalar(scaleFactor);
            autoRotate = earth.scale.x <= 1.5;

            // Immediately hide the text upon scrolling
            document.querySelector('.urban-text').style.opacity = '0';
            document.querySelector('.oceans-text').style.opacity = '0';
        }



        function onMouseDown(e) {
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        }

        function onMouseMove(e) {
            if (!isDragging || autoRotate) return;
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            earth.rotation.y += deltaX * 0.01;
            earth.rotation.x += deltaY * 0.01;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        }

        function onMouseUp() {
            isDragging = false;
        }

        function fadeScreenAndZoomToButton() {
            const targetPosition = buttonAtlantic.position.clone();
            const initialPosition = camera.position.clone();
            new TWEEN.Tween({ opacity: 0, zoom: 0 })
                .to({ opacity: 1, zoom: 1 }, 1500)
                .easing(TWEEN.Easing.Quadratic.InOut)
                .onUpdate(({ opacity, zoom }) => {
                    document.getElementById('fadeOverlay').style.opacity = opacity;
                    camera.position.lerpVectors(initialPosition, targetPosition, zoom);
                    camera.lookAt(earth.position);
                })
                .onComplete(() => window.location.href = 'ocean')
                .start();
        }
    </script>
</body>
</html>
